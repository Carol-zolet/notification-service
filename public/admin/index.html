<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Gerenciar Colaboradores</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 30px; }
    h1 { color: #333; margin-bottom: 30px; }
    .section { margin-bottom: 40px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: 600; margin-bottom: 5px; color: #555; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    button { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
    button:hover { background: #0056b3; }
    button.delete { background: #dc3545; padding: 8px 16px; font-size: 13px; }
    button.delete:hover { background: #c82333; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #f8f9fa; font-weight: 600; color: #333; }
    tr:hover { background: #f8f9fa; }
    .message { padding: 12px; border-radius: 4px; margin-bottom: 20px; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🏢 Gerenciar Colaboradores - RH</h1>
    
    <div id="message"></div>

    <div class="section">
      <h2>➕ Adicionar Novo Colaborador</h2>
      <form id="addForm">
        <div class="form-group">
          <label for="nome">Nome Completo</label>
          <input type="text" id="nome" required>
        </div>
        <div class="form-group">
          <label for="email">Email Corporativo</label>
          <input type="email" id="email" required>
        </div>
        <div class="form-group">
          <label for="filial">Filial</label>
          <input type="text" id="filial" placeholder="Ex: Matriz Porto Alegre" list="filialSuggestions" required>
          <datalist id="filialSuggestions"></datalist>
        </div>
        <button type="submit">Adicionar Colaborador</button>
      </form>
    </div>

    <div class="section">
      <h2> Colaboradores Cadastrados</h2>
      <div class="form-group">
        <label for="filterFilial">Filtrar por Filial</label>
        <select id="filterFilial">
          <option value="">Todas as filiais</option>
        </select>
      </div>
      <table id="colabTable">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Email</th>
            <th>Filial</th>
            <th>Cadastrado em</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="colabList">
          <tr><td colspan="5" style="text-align:center;">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
  // Em ambiente de desenvolvimento estático (ex.: python -m http.server)
  // o servidor não faz proxy para o backend, então apontamos a URL
  // absoluta para o backend em Render para testes locais.
  // Em produção com Vercel, use a variável de build VITE_API_BASE_URL.
  const API_URL = 'https://notification-service-rmnv.onrender.com/api/v1';
    
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.innerHTML = `<div class="${type}">${text}</div>`;
      setTimeout(() => msg.innerHTML = '', 5000);
    }

    async function loadFiliais() {
      try {
        const res = await fetch(`${API_URL}/filiais`);
        const filiais = await res.json();
        
        const select = document.getElementById('filterFilial');
        const datalist = document.getElementById('filialSuggestions');
        
        select.innerHTML = '<option value="">Todas as filiais</option>';
        datalist.innerHTML = '';
        
        filiais.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f;
          opt.textContent = f;
          select.appendChild(opt);
          
          const option = document.createElement('option');
          option.value = f;
          datalist.appendChild(option);
        });
      } catch (error) {
        showMessage('Erro ao carregar filiais', 'error');
      }
    }

    async function loadColaboradores(filial = '') {
      try {
        let colaboradores = [];
        
        if (!filial) {
          const resFiliais = await fetch(`${API_URL}/filiais`);
          const filiais = await resFiliais.json();
          
          for (const f of filiais) {
            const res = await fetch(`${API_URL}/colaboradores?filial=${encodeURIComponent(f)}`);
            const colabs = await res.json();
            colaboradores = [...colaboradores, ...colabs];
          }
        } else {
          const res = await fetch(`${API_URL}/colaboradores?filial=${encodeURIComponent(filial)}`);
          colaboradores = await res.json();
        }

        const tbody = document.getElementById('colabList');
        
        if (colaboradores.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhum colaborador cadastrado</td></tr>';
          return;
        }

        tbody.innerHTML = colaboradores.map(c => `
          <tr>
            <td>${c.nome}</td>
            <td>${c.email}</td>
            <td>${c.filial}</td>
            <td>${new Date(c.createdAt).toLocaleDateString('pt-BR')}</td>
            <td><button class="delete" onclick="deleteColab('${c.id}', '${c.nome}')">Remover</button></td>
          </tr>
        `).join('');
      } catch (error) {
        showMessage('Erro ao carregar colaboradores: ' + error.message, 'error');
      }
    }

    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        nome: document.getElementById('nome').value.trim(),
        email: document.getElementById('email').value.trim(),
        filial: document.getElementById('filial').value.trim()
      };

      try {
        const res = await fetch(`${API_URL}/colaboradores`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Erro ao adicionar');
        }

        showMessage(` Colaborador ${data.nome} adicionado com sucesso!`, 'success');
        e.target.reset();
        await loadFiliais();
        await loadColaboradores(document.getElementById('filterFilial').value);
      } catch (error) {
        showMessage(' Erro: ' + error.message, 'error');
      }
    });

    async function deleteColab(id, nome) {
      if (!confirm(`Tem certeza que deseja remover ${nome}?`)) return;

      try {
        const res = await fetch(`${API_URL}/colaboradores/${id}`, { method: 'DELETE' });
        
        if (!res.ok) throw new Error('Erro ao remover');

        showMessage(` ${nome} removido com sucesso!`, 'success');
        await loadFiliais();
        await loadColaboradores(document.getElementById('filterFilial').value);
      } catch (error) {
        showMessage(' Erro: ' + error.message, 'error');
      }
    }

    document.getElementById('filterFilial').addEventListener('change', (e) => {
      loadColaboradores(e.target.value);
    });

    loadFiliais();
    loadColaboradores();
  </script>
</body>
</html>
